<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProQuiz Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        body.lang-hi {
            font-family: 'Roboto', sans-serif;
        }

        .quiz-container {
            background-color: rgba(45, 55, 72, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255,255,255,0.05) inset;
            width: 95%;
            max-width: 700px;
            text-align: center;
            border: 1px solid rgba(74, 85, 104, 0.5);
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 640px) {
            .quiz-container {
                padding: 30px;
            }
        }

        .screen {
            display: none;
            animation: fadeIn 0.7s ease-out forwards;
        }

        .screen.active {
            display: block;
        }

        .screen.exiting {
            animation: fadeOut 0.5s ease-in forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .grid-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Adjusted minmax */
                gap: 12px; /* Adjusted gap */
            }
        }

        .action-button {
            background-color: #4a5568;
            color: #e2e8f0;
            border: none;
            padding: 10px 12px; /* Adjusted padding */
            border-radius: 8px;
            font-size: 0.8rem; /* Adjusted font size */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: 600;
        }

        @media (min-width: 640px) {
             .action-button {
                padding: 12px 18px; /* Adjusted padding */
                font-size: 0.9rem; /* Adjusted font size */
             }
        }

        .action-button:hover {
            background-color: #718096;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .action-button.all-sections, .action-button.language-select {
            background-color: #4c51bf;
        }
        .action-button.all-sections:hover, .action-button.language-select:hover {
            background-color: #434190;
        }
        .action-button.all-sections {
             grid-column: 1 / -1;
        }

        .question-text {
            font-size: 1.1rem;  /* Adjusted */
            margin-bottom: 20px;
            min-height: 60px;
            color: #cbd5e0;
            font-weight: 600;
        }
        @media (min-width: 640px) {
            .question-text {
                font-size: 1.3rem; /* Adjusted */
            }
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        @media (min-width: 640px) {
            .options-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .action-button.option {
            background-color: #2d3748;
            border: 1px solid #4a5568;
        }
        .action-button.option:hover {
            background-color: #4a5568;
        }

        .timer-container {
            margin-bottom: 20px;
            height: 30px;
            position: relative;
        }

        .timer-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #63b3ed;
            font-weight: 700;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .timer-bar-background {
            width: 100%;
            height: 10px;
            background-color: #4a5568;
            border-radius: 5px;
            position: absolute;
            bottom: 0;
            left:0;
        }

        .timer-bar {
            height: 100%;
            background-color: #63b3ed;
            border-radius: 5px;
            width: 100%;
            transition: width 0.2s linear, background-color 0.5s ease;
        }

        .score-display {
            font-size: 1.25rem;
            margin: 15px 0; /* Adjusted margin */
            color: #a0aec0;
        }
        @media (min-width: 640px) {
            .score-display {
                font-size: 1.4rem; /* Adjusted */
            }
        }

        .results-summary {
            font-size: 1.1rem; /* Adjusted */
            margin-bottom: 15px; /* Adjusted margin */
            line-height: 1.6;
        }
        .results-summary span {
            font-weight: bold;
        }
        .results-summary .correct { color: #48bb78; }
        .results-summary .wrong { color: #f56565; }

        .control-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px; /* Adjusted margin */
            justify-content: center;
        }

        @media (min-width: 640px) {
            .control-buttons-container {
                flex-direction: row;
                gap: 12px; /* Adjusted gap */
            }
        }

        .action-button.next-level { background-color: #38a169; }
        .action-button.next-level:hover { background-color: #2f855a; }
        .action-button.retry { background-color: #dd6b20; }
        .action-button.retry:hover { background-color: #c05621; }
        .action-button.show-answers, .action-button.home, .action-button.change-lang, .action-button.try-diff-cat { background-color: #718096; }
        .action-button.show-answers:hover, .action-button.home:hover, .action-button.change-lang:hover, .action-button.try-diff-cat:hover { background-color: #4a5568; }

        .answers-reveal-container {
            margin-top: 15px; /* Adjusted margin */
            text-align: left;
            max-height: 180px; /* Adjusted max-height */
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .answers-reveal-container p {
            margin-bottom: 8px;
            font-size: 0.875rem;
        }
        .answers-reveal-container strong {
            color: #63b3ed;
        }

        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
            color: #90cdf4;
            margin-bottom: 10px;
        }
        h1 { font-size: 1.6rem; }  /* Adjusted */
        h2 { font-size: 1.2rem; }  /* Adjusted */
        h3 { font-size: 1rem; margin-top: 12px; } /* Adjusted */
        @media (min-width: 640px) {
            h1 { font-size: 2rem; } /* Adjusted */
            h2 { font-size: 1.4rem; } /* Adjusted */
        }

        .action-button.option {
            opacity: 0;
            transform: translateY(10px);
            animation: optionFadeIn 0.5s ease-out forwards;
        }
        .options-container .action-button.option:nth-child(1) { animation-delay: 0.1s; }
        .options-container .action-button.option:nth-child(2) { animation-delay: 0.2s; }
        .options-container .action-button.option:nth-child(3) { animation-delay: 0.3s; }
        .options-container .action-button.option:nth-child(4) { animation-delay: 0.4s; }
        .options-container .action-button.option:nth-child(5) { animation-delay: 0.5s; } /* For 5th option if any */

        @keyframes optionFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .timer-text.low-time {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div id="language-screen" class="screen active">
            <h1 id="lang-select-title">Select Language / भाषा चुनें</h1>
            <div class="grid-container mt-6">
                <button id="lang-en" class="action-button language-select">English</button>
                <button id="lang-hi" class="action-button language-select">हिन्दी (Hindi)</button>
            </div>
        </div>

        <div id="start-screen" class="screen">
            <h1 id="start-title">ProQuiz Challenge</h1>
            <p id="start-subtitle" class="mb-6 text-slate-400">Test your knowledge across various domains!</p>
            <h2 id="category-select-title">Select a Category:</h2>
            <div id="category-selection" class="grid-container">
                </div>
            <button id="all-sections-button" class="action-button all-sections mt-4"></button>
            <button id="change-language-button" class="action-button change-lang mt-4"></button>
        </div>

        <div id="quiz-screen" class="screen">
            <div id="quiz-header" class="flex justify-between items-center mb-4">
                <p id="current-level-topic" class="text-lg font-semibold text-sky-400"></p>
                <p id="question-counter" class="text-sm text-slate-400"></p>
            </div>
            <div class="timer-container">
                <div class="timer-bar-background">
                    <div id="timer-bar" class="timer-bar"></div>
                </div>
                <div id="timer-text" class="timer-text">25</div>
            </div>
            <p id="question-text" class="question-text">
                </p>
            <div id="options-container" class="options-container">
                </div>
            <div class="control-buttons-container">
                <button id="quit-quiz-button" class="action-button retry">Quit Quiz</button>
            </div>
        </div>

        <div id="results-screen" class="screen">
            <h2 id="results-title" class="mb-4">Quiz Results</h2>
            <p id="score-display" class="score-display">Your Score: <span>0</span>/<span>0</span></p>
            <p id="level-completion-status" class="results-summary"></p>
            <p id="topic-level-display" class="text-md text-slate-300 mb-4"></p>
            <div id="answers-reveal-container" class="answers-reveal-container">
                </div>
            <div class="control-buttons-container">
                <button id="next-level-button" class="action-button next-level">Next Level</button>
                <button id="retry-level-button" class="action-button retry">Retry Level</button>
                <button id="show-answers-button" class="action-button show-answers">Show Answers</button>
                <button id="try-diff-cat-button" class="action-button try-diff-cat">Try Different Category</button>
                <button id="home-button" class="action-button home">Home</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const languageScreen = document.getElementById('language-screen');
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');

        const langEnButton = document.getElementById('lang-en');
        const langHiButton = document.getElementById('lang-hi');
        const langSelectTitle = document.getElementById('lang-select-title');

        const startTitle = document.getElementById('start-title');
        const startSubtitle = document.getElementById('start-subtitle');
        const categorySelectTitle = document.getElementById('category-select-title');
        const categorySelection = document.getElementById('category-selection');
        const allSectionsButton = document.getElementById('all-sections-button');
        const changeLanguageButton = document.getElementById('change-language-button');

        const currentLevelTopic = document.getElementById('current-level-topic');
        const questionCounter = document.getElementById('question-counter');
        const timerText = document.getElementById('timer-text');
        const timerBar = document.getElementById('timer-bar');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const quitQuizButton = document.getElementById('quit-quiz-button');

        const resultsTitle = document.getElementById('results-title');
        const scoreDisplay = document.getElementById('score-display');
        const levelCompletionStatus = document.getElementById('level-completion-status');
        const topicLevelDisplay = document.getElementById('topic-level-display');
        const answersRevealContainer = document.getElementById('answers-reveal-container');
        const nextLevelButton = document.getElementById('next-level-button');
        const retryLevelButton = document.getElementById('retry-level-button');
        const showAnswersButton = document.getElementById('show-answers-button');
        const tryDiffCatButton = document.getElementById('try-diff-cat-button');
        const homeButton = document.getElementById('home-button');

        // Quiz State Variables
        let currentLang = 'en'; // Default language
        let currentCategory = '';
        let currentLevel = 1; // Tracks current level within a category
        let currentQuestionIndex = 0; // Tracks question index within the current level's questions
        let score = 0;
        let correctAnswersCount = 0;
        let incorrectAnswersCount = 0;
        let timerId;
        const TIME_PER_QUESTION = 25; // seconds
        let timeLeft = TIME_PER_QUESTION;
        let currentLevelQuestions = []; // Questions for the current category and level
        let askedQuestionGlobalIds = new Set(); // To keep track of asked questions for "All Sections"

        // Global variable to store questions from JSON
        let externalQuestions = {}; // Will be loaded from questions.json

        // --- Utility Functions ---
        function switchScreen(screenId) {
            const screens = [languageScreen, startScreen, quizScreen, resultsScreen];
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.remove('exiting');
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });
        }

        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #2d3748;
                padding: 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                z-index: 1000;
                color: #e2e8f0;
                font-size: 1.1rem;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="
                    margin-top: 15px;
                    padding: 8px 15px;
                    background-color: #4c51bf;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                ">OK</button>
            `;
            document.body.appendChild(messageBox);

            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Core Quiz Logic ---
        function setLanguage(lang) {
            currentLang = lang;
            document.body.classList.remove('lang-en', 'lang-hi');
            document.body.classList.add(`lang-${lang}`);

            // If Hindi is selected, show a message and still use English questions from externalQuestions
            if (currentLang === 'hi') {
                showMessageBox("हिंदी सामग्री जल्द ही आ रही है! अभी के लिए, क्विज़ अंग्रेजी में चल रहा है।");
            }

            updateTextsForLanguage();
            displayCategories(); // Redraw categories based on available questions (from externalQuestions)
            switchScreen('start-screen');
        }

        function updateTextsForLanguage() {
            if (currentLang === 'en') {
                startTitle.textContent = "ProQuiz Challenge";
                startSubtitle.textContent = "Test your knowledge across various domains!";
                categorySelectTitle.textContent = "Select a Category:";
                allSectionsButton.textContent = "All Sections (Mixed)";
                changeLanguageButton.textContent = "Change Language";
                resultsTitle.textContent = "Quiz Results";
                quitQuizButton.textContent = "Quit Quiz";
                nextLevelButton.textContent = "Next Level";
                retryLevelButton.textContent = "Retry Level";
                showAnswersButton.textContent = "Show Answers";
                tryDiffCatButton.textContent = "Try Different Category";
                homeButton.textContent = "Home";
            } else { // Hindi (using English translations for now, except for specific button texts)
                startTitle.textContent = "प्रोक्विज़ चैलेंज";
                startSubtitle.textContent = "विभिन्न विषयों पर अपने ज्ञान का परीक्षण करें!";
                categorySelectTitle.textContent = "एक श्रेणी चुनें:";
                allSectionsButton.textContent = "सभी अनुभाग (मिश्रित)";
                changeLanguageButton.textContent = "भाषा बदलें";
                resultsTitle.textContent = "क्विज़ परिणाम";
                quitQuizButton.textContent = "क्विज़ छोड़ें";
                nextLevelButton.textContent = "अगला स्तर";
                retryLevelButton.textContent = "स्तर पुनः प्रयास करें";
                showAnswersButton.textContent = "उत्तर दिखाएं";
                tryDiffCatButton.textContent = "अलग श्रेणी आज़माएँ";
                homeButton.textContent = "होम";
            }
        }

        function displayCategories() {
            categorySelection.innerHTML = ''; // Clear existing buttons
            // Add category buttons for categories found in externalQuestions
            for (const category in externalQuestions) {
                if (externalQuestions.hasOwnProperty(category)) {
                    const button = document.createElement('button');
                    button.classList.add('action-button');
                    button.textContent = category;
                    button.dataset.category = category;
                    button.addEventListener('click', () => startGame(category));
                    categorySelection.appendChild(button);
                }
            }
        }

        // Constants for "All Sections" mode
        const ALL_SECTIONS_QUESTIONS_PER_LEVEL = 36;
        const ALL_SECTIONS_TOTAL_LEVELS = 10;
        const ALL_SECTIONS_PASSING_SCORE = 30; // Correct answers needed to pass

        function startGame(categoryName) {
            currentCategory = categoryName;
            currentLevel = 1;
            score = 0;
            correctAnswersCount = 0;
            incorrectAnswersCount = 0;
            askedQuestionGlobalIds.clear(); // Reset for a new game/category

            loadLevelQuestions();
            startQuizTimer();
            switchScreen('quiz-screen');
        }

        function loadLevelQuestions() {
            if (currentCategory === "All Sections") {
                // For "All Sections", get random questions from all categories
                currentLevelQuestions = getRandomQuestionsFromAllCategories(ALL_SECTIONS_QUESTIONS_PER_LEVEL);
                if (currentLevelQuestions.length === 0) {
                    showMessageBox(currentLang === 'en' ? "Not enough unique questions available for 'All Sections' mode. Please try again later or select a specific category." : "सभी अनुभागों के लिए पर्याप्त अद्वितीय प्रश्न उपलब्ध नहीं हैं। कृपया बाद में पुनः प्रयास करें या कोई विशिष्ट श्रेणी चुनें।");
                    switchScreen('start-screen');
                    return;
                }
            } else {
                // For specific categories, use the level-based structure from JSON
                if (externalQuestions[currentCategory] && externalQuestions[currentCategory].length > 0) {
                    const levelData = externalQuestions[currentCategory].find(l => l.level === currentLevel);

                    if (levelData) {
                        currentLevelQuestions = shuffleArray([...levelData.questions]); // Shuffle questions for the current level
                    } else {
                        // This means all 6 levels for the category are completed
                        endQuiz(true); // Treat as category completion
                        return; // Exit to prevent further execution
                    }
                } else {
                    showMessageBox(currentLang === 'en' ? "No questions available for this category or level." : "इस श्रेणी या स्तर के लिए कोई प्रश्न उपलब्ध नहीं हैं।");
                    switchScreen('start-screen');
                    return; // Exit
                }
            }
            currentQuestionIndex = 0; // Start from the first question of the new level/set
            loadQuestion();
        }

        function getRandomQuestionsFromAllCategories(count) {
            let allAvailableQuestions = [];
            for (const category in externalQuestions) { // Always use externalQuestions for "All Sections"
                if (externalQuestions.hasOwnProperty(category)) {
                    externalQuestions[category].forEach(levelData => {
                        allAvailableQuestions.push(...levelData.questions);
                    });
                }
            }

            // Filter out questions already asked in the current "All Sections" session
            let poolOfNewQuestions = allAvailableQuestions.filter(q => !askedQuestionGlobalIds.has(q.id));

            // If we don't have enough *new* questions, and if there are enough total questions,
            // we can reset the 'asked' set to allow questions to be reused.
            // This prevents the quiz from stopping prematurely if the user plays many mixed levels.
            if (poolOfNewQuestions.length < count && allAvailableQuestions.length >= count) {
                console.warn("Not enough unique questions for 'All Sections' level. Reusing questions.");
                askedQuestionGlobalIds.clear(); // Clear all asked questions for "All Sections"
                poolOfNewQuestions = [...allAvailableQuestions]; // Reset the pool
            } else if (poolOfNewQuestions.length < count && allAvailableQuestions.length < count) {
                // If even the total available questions are less than required for one level, show error
                console.error("Critical: Total questions available are less than required for one 'All Sections' level.");
                return []; // Return empty array to signal failure
            }


            const selected = [];
            for (let i = 0; i < count; i++) {
                if (poolOfNewQuestions.length === 0) {
                    // This case should ideally be caught by the check above, but as a safeguard
                    console.warn("Ran out of questions while selecting for 'All Sections'.");
                    break;
                }
                const randomIndex = Math.floor(Math.random() * poolOfNewQuestions.length);
                const question = poolOfNewQuestions.splice(randomIndex, 1)[0];
                selected.push(question);
                askedQuestionGlobalIds.add(question.id); // Mark this question as asked
            }
            return selected;
        }

        function loadQuestion() {
            clearTimeout(timerId); // Clear any previous timer
            timeLeft = TIME_PER_QUESTION; // Reset timer for new question
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#63b3ed'; // Reset color
            timerText.classList.remove('low-time');
            timerText.textContent = timeLeft;

            if (currentQuestionIndex < currentLevelQuestions.length) {
                const questionData = currentLevelQuestions[currentQuestionIndex];
                // Access question and answer directly as they are strings in JSON
                questionText.textContent = questionData.question;
                optionsContainer.innerHTML = '';

                shuffleArray(questionData.options).forEach((option, index) => {
                    const button = document.createElement('button');
                    button.classList.add('action-button', 'option');
                    button.textContent = option;
                    button.dataset.index = index; // Store original index for animation delay
                    button.onclick = () => checkAnswer(option, questionData.answer);
                    optionsContainer.appendChild(button);
                });

                // Update topic display based on mode
                if (currentCategory === "All Sections") {
                    currentLevelTopic.textContent = `${currentLang === 'en' ? 'Mixed Categories' : 'मिश्रित श्रेणियाँ'} - Level ${currentLevel}`;
                    questionCounter.textContent = `${currentQuestionIndex + 1} / ${ALL_SECTIONS_QUESTIONS_PER_LEVEL}`;
                } else {
                    currentLevelTopic.textContent = `${currentCategory} - Level ${currentLevel}`;
                    questionCounter.textContent = `${currentQuestionIndex + 1} / ${currentLevelQuestions.length}`;
                }
                startQuizTimer();
            } else {
                // All questions in the current level answered
                endQuiz(false); // Indicates level completion, not overall quiz end
            }
        }

        function startQuizTimer() {
            timerText.textContent = timeLeft;
            timerId = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                timerBar.style.width = (timeLeft / TIME_PER_QUESTION) * 100 + '%';

                if (timeLeft <= 5) {
                    timerBar.style.backgroundColor = '#f56565'; // Red for low time
                    timerText.classList.add('low-time');
                } else {
                    timerBar.style.backgroundColor = '#63b3ed'; // Blue for normal time
                    timerText.classList.remove('low-time');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    incorrectAnswersCount++;
                    // Update score display immediately for visual feedback
                    scoreDisplay.querySelector('span:first-child').textContent = correctAnswersCount;
                    scoreDisplay.querySelector('span:last-child').textContent = correctAnswersCount + incorrectAnswersCount;
                    // Automatically move to next question if time runs out
                    setTimeout(nextQuestion, 1000); // Give a small delay before next question
                }
            }, 1000);
        }

        function checkAnswer(selectedOption, correctAnswer) {
            clearInterval(timerId); // Stop the timer
            const optionsButtons = optionsContainer.querySelectorAll('.action-button.option');
            optionsButtons.forEach(button => {
                button.disabled = true; // Disable all options after selection
                if (button.textContent === correctAnswer) {
                    button.style.backgroundColor = '#48bb78'; // Green for correct
                } else if (button.textContent === selectedOption) {
                    button.style.backgroundColor = '#f56565'; // Red for incorrect selected
                }
            });

            if (selectedOption === correctAnswer) {
                score++;
                correctAnswersCount++;
            } else {
                incorrectAnswersCount++;
            }

            scoreDisplay.querySelector('span:first-child').textContent = correctAnswersCount;
            scoreDisplay.querySelector('span:last-child').textContent = correctAnswersCount + incorrectAnswersCount;

            setTimeout(nextQuestion, 1500); // Move to next question after a short delay
        }

        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        function endQuiz(categoryCompleted = false) {
            clearTimeout(timerId);
            switchScreen('results-screen');

            let totalQuestionsInLevel;
            let passingScore;
            let totalLevelsForMode;

            if (currentCategory === "All Sections") {
                totalQuestionsInLevel = ALL_SECTIONS_QUESTIONS_PER_LEVEL;
                passingScore = ALL_SECTIONS_PASSING_SCORE;
                totalLevelsForMode = ALL_SECTIONS_TOTAL_LEVELS;
            } else {
                totalQuestionsInLevel = currentLevelQuestions.length;
                passingScore = 7; // Assuming 70% for 10 questions/level (7 correct)
                totalLevelsForMode = externalQuestions[currentCategory].length; // 6 levels per category
            }

            // Update scores
            scoreDisplay.querySelector('span:first-child').textContent = correctAnswersCount;
            scoreDisplay.querySelector('span:last-child').textContent = totalQuestionsInLevel;

            const percentage = (correctAnswersCount / totalQuestionsInLevel) * 100;

            let statusMessage = "";
            let nextLevelPossible = false;
            let currentLevelTopicText = "";

            if (currentCategory === "All Sections") {
                currentLevelTopicText = `${currentLang === 'en' ? 'Mixed Categories' : 'मिश्रित श्रेणियाँ'} - Level ${currentLevel}`;
                if (correctAnswersCount >= passingScore) {
                    statusMessage = `${currentLang === 'en' ? 'Congratulations! You passed Level' : 'बधाई हो! आपने स्तर'} ${currentLevel} ${currentLang === 'en' ? 'of Mixed Categories with' : 'मिश्रित श्रेणियों के साथ'} <span class="correct">${percentage.toFixed(0)}%</span> ${currentLang === 'en' ? 'accuracy.' : 'सटीकता।'}`;
                    nextLevelPossible = true;
                } else {
                    statusMessage = `${currentLang === 'en' ? 'You completed Level' : 'आपने स्तर'} ${currentLevel} ${currentLang === 'en' ? 'of Mixed Categories with' : 'मिश्रित श्रेणियों के साथ'} <span class="wrong">${percentage.toFixed(0)}%</span> ${currentLang === 'en' ? 'accuracy. You need' : 'सटीकता। आपको चाहिए'} ${passingScore} ${currentLang === 'en' ? 'correct answers to unlock the next level.' : 'सही उत्तर अगले स्तर को अनलॉक करने के लिए।'}`;
                    nextLevelPossible = false;
                }
            } else { // Specific Category
                currentLevelTopicText = `${currentCategory} - Level ${currentLevel}`;
                if (percentage >= passingScore) {
                    statusMessage = `${currentLang === 'en' ? 'Congratulations! You passed Level' : 'बधाई हो! आपने स्तर'} ${currentLevel} ${currentLang === 'en' ? 'of' : 'का'} ${currentCategory} ${currentLang === 'en' ? 'with' : 'के साथ'} <span class="correct">${percentage.toFixed(0)}%</span> ${currentLang === 'en' ? 'accuracy.' : 'सटीकता।'}`;
                    nextLevelPossible = true;
                } else {
                    statusMessage = `${currentLang === 'en' ? 'You completed Level' : 'आपने स्तर'} ${currentLevel} ${currentLang === 'en' ? 'of' : 'का'} ${currentCategory} ${currentLang === 'en' ? 'with' : 'के साथ'} <span class="wrong">${percentage.toFixed(0)}%</span> ${currentLang === 'en' ? 'accuracy. You need to score at least' : 'सटीकता। आपको कम से कम स्कोर करने की आवश्यकता है'} ${passingScore}% ${currentLang === 'en' ? 'to unlock the next level.' : 'अगले स्तर को अनलॉक करने के लिए।'}`;
                    nextLevelPossible = false;
                }
            }

            levelCompletionStatus.innerHTML = statusMessage;
            topicLevelDisplay.textContent = currentLevelTopicText;

            // Show/Hide Next Level button
            if (nextLevelPossible && currentLevel < totalLevelsForMode) {
                nextLevelButton.style.display = 'inline-block';
            } else {
                nextLevelButton.style.display = 'none';
                if (currentLevel >= totalLevelsForMode && correctAnswersCount >= passingScore) {
                    // All levels completed for the current mode/category
                    levelCompletionStatus.innerHTML = `${currentLang === 'en' ? 'Fantastic! You have completed all levels for this mode!' : 'शानदार! आपने इस मोड के सभी स्तर पूरे कर लिए हैं!'}`;
                }
            }

            // Always show retry, show answers, try different category, home
            retryLevelButton.style.display = 'inline-block';
            showAnswersButton.style.display = 'inline-block';
            tryDiffCatButton.style.display = 'inline-block';
            homeButton.style.display = 'inline-block';

            // Show answers
            displayAnswers();
        }

        function displayAnswers() {
            answersRevealContainer.innerHTML = '';
            answersRevealContainer.innerHTML = `<h3>${currentLang === 'en' ? 'Answers for this Level:' : 'इस स्तर के उत्तर:'}</h3>`;
            currentLevelQuestions.forEach((q, index) => {
                const p = document.createElement('p');
                const qNum = index + 1;
                const questionTextSnippet = q.question.length > 50 ? q.question.substring(0, 50) + '...' : q.question;
                p.innerHTML = `<strong>Q${qNum}:</strong> ${questionTextSnippet}<br> <span style="color:#48bb78;">${currentLang === 'en' ? 'Correct Answer:' : 'सही उत्तर:'} ${q.answer}</span>`;
                answersRevealContainer.appendChild(p);
            });
        }

        // --- Event Listeners for Navigation ---
        nextLevelButton.addEventListener('click', () => {
            currentLevel++;
            score = 0; // Reset score for the new level
            correctAnswersCount = 0;
            incorrectAnswersCount = 0;
            loadLevelQuestions();
            switchScreen('quiz-screen');
        });

        retryLevelButton.addEventListener('click', () => {
            score = 0; // Reset score for retry
            correctAnswersCount = 0;
            incorrectAnswersCount = 0;
            // For "All Sections", clear asked questions for a fresh retry of the level
            if (currentCategory === "All Sections") {
                askedQuestionGlobalIds.clear(); // Ensure fresh questions for retry
            }
            loadLevelQuestions(); // Reload questions for the same level
            switchScreen('quiz-screen');
        });

        showAnswersButton.addEventListener('click', () => {
            showMessageBox(currentLang === 'en' ? "Answers are displayed below the score summary." : "उत्तर स्कोर सारांश के नीचे प्रदर्शित किए गए हैं।");
        });

        tryDiffCatButton.addEventListener('click', () => {
            clearTimeout(timerId);
            switchScreen('start-screen');
        });

        homeButton.addEventListener('click', () => {
            clearTimeout(timerId);
            currentLevel = 1; // Reset level on going home
            askedQuestionGlobalIds.clear(); // Clear on going home
            switchScreen('language-screen'); // Go back to language selection
        });

        quitQuizButton.addEventListener('click', () => {
            clearTimeout(timerId);
            currentLevel = 1; // Reset level on quitting
            askedQuestionGlobalIds.clear(); // Clear on quitting
            switchScreen('start-screen');
        });

        // --- Initialization ---
        // Fetch questions.json
        fetch('questions.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                externalQuestions = data;
                console.log("questions.json loaded successfully:", externalQuestions);
                // After loading, set initial language and display categories
                setLanguage('en'); // Set default to English after loading JSON
            })
            .catch(error => {
                console.error("Error loading questions.json:", error);
                showMessageBox(currentLang === 'en' ? "Failed to load quiz questions. Please check the 'questions.json' file and ensure it's valid JSON." : "क्विज़ प्रश्न लोड करने में विफल। कृपया 'questions.json' फ़ाइल की जाँच करें और सुनिश्चित करें कि यह वैध JSON है।");
                // Fallback or disable English quiz if JSON fails to load
                langEnButton.disabled = true;
            });


        langEnButton.addEventListener('click', () => setLanguage('en'));
        langHiButton.addEventListener('click', () => setLanguage('hi'));
        changeLanguageButton.addEventListener('click', () => {
            clearTimeout(timerId);
            switchScreen('language-screen');
        });

        // Event listener for the "All Sections" button
        allSectionsButton.addEventListener('click', () => startGame("All Sections"));

        // Initial screen setup
        switchScreen('language-screen');
        document.getElementById('lang-select-title').textContent = "Select Language / भाषा चुनें"; // Ensure this is set on load
    </script>
</body>
</html>

